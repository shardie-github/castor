# Phase 2 — Extension Plan
**RUN-ID:** 20251113T114706Z  
**Timestamp:** 2025-11-13T11:47:06Z UTC

## PLAN OVERVIEW

Based on Phase 1 inventory, most core features already exist. This plan focuses on **additive-only enhancements** to fill gaps and ensure completeness.

---

## A) ETL FALLBACKS

### Current State
- ✅ CSV importer exists (`src/etl/csv_importer.py`)
- ✅ CSV upload API exists (`POST /api/v1/etl/upload`)
- ✅ Frontend CSV uploader exists (`frontend/components/etl/CSVUploader.tsx`)
- ✅ Google Sheets integration exists (`src/etl/google_sheets.py`)

### Gaps Identified
1. CSV importer writes to `listener_metrics`, not `metrics_daily` (materialized view)
2. Missing sample CSV files for documentation/testing
3. Missing Google Sheets Apps Script snippet (if appropriate)

### Delta Changes

#### A1) CSV Import Path Enhancement
**Current:** CSV → `listener_metrics` → (manual refresh) → `metrics_daily` view

**Proposed:** Add option to upsert directly to `metrics_daily` table OR ensure automatic view refresh

**Decision:** Since `metrics_daily` is a MATERIALIZED VIEW, we have two options:
- Option 1: Convert `metrics_daily` to a table (destructive - REJECTED)
- Option 2: Keep view, add refresh trigger after CSV import (ADDITIVE - ACCEPTED)
- Option 3: Document that CSV import requires view refresh (NO CHANGE - ACCEPTED)

**Chosen:** Option 3 + verify unique index exists for future table conversion

**Changes:**
- Verify `ux_metrics_daily_day_ep_source` index exists (or create if missing)
- Document CSV import → view refresh workflow
- **NO CODE CHANGES** (existing flow is acceptable)

#### A2) Sample CSV Files
**Action:** Create sample files for documentation/testing
- `samples/metrics_daily.csv` - Sample metrics data
- `samples/io_bookings.csv` - Sample IO booking data

**Changes:** New files only (additive)

#### A3) Google Sheets Apps Script (Optional)
**Action:** Add Apps Script snippet if appropriate for repo
- `docs/sheets/push_metrics_daily.gs` - Apps Script for Google Sheets sync

**Changes:** New file only (additive, optional)

---

## B) DEAL PIPELINE & IO

### Current State
- ✅ Deal pipeline API exists (`/api/v1/deals`)
- ✅ `campaigns` table has `stage` and `stage_changed_at` columns
- ✅ IO bookings API exists (`/api/v1/io`)
- ✅ `io_bookings` table exists with `promo_code` and `vanity_url` columns
- ✅ IO PDF export endpoint exists

### Gaps Identified
1. Missing `io.delivered` event emission
2. May need to verify IO workflow completeness

### Delta Changes

#### B1) IO Delivered Event
**Action:** Add `io.delivered` event when IO status changes to 'completed'

**Changes:**
- Small addition to IO API status update logic
- Emit event: `io.delivered` with IO details

**File:** `src/api/io.py` (add event emission)

---

## C) MATCHMAKING ENDPOINT

### Current State
- ✅ Matchmaking endpoint exists (`POST /api/match/recalculate`)
- ✅ Matchmaking engine exists (`src/matchmaking/engine.py`)
- ✅ `matches` table exists
- ✅ Feature flag: `ENABLE_MATCHMAKING` (not `MATCHMAKING_ENABLED`)

### Gaps Identified
1. Feature flag name mismatch (`ENABLE_MATCHMAKING` vs `MATCHMAKING_ENABLED`)

### Delta Changes

#### C1) Feature Flag Alignment
**Action:** Document existing flag OR add alias

**Decision:** Document existing `ENABLE_MATCHMAKING` flag (no code change needed)

**Changes:** Documentation only

---

## D) DASHBOARD CARDS

### Current State
- ✅ Creator dashboard API exists (`/api/v1/dashboard/creator`)
- ✅ Advertiser dashboard API exists (`/api/v1/dashboard/advertiser`)
- ✅ Ops dashboard API exists (`/api/v1/dashboard/ops`)
- ✅ Frontend dashboard components exist

### Gaps Identified
None - dashboards are complete

### Delta Changes
**NONE** - Dashboards already implemented

---

## E) EVENTS/LOGS

### Current State
- ✅ Event logger exists (`src/telemetry/events.py`)
- ✅ Events emitted for:
  - `deal.stage_changed` ✅
  - `io.scheduled` ✅
  - `match.recalculated` ✅
  - `etl.import_completed` ✅
  - `etl.error` ✅

### Gaps Identified
1. Missing `io.delivered` event

### Delta Changes

#### E1) IO Delivered Event
**Action:** Add `io.delivered` event emission (covered in B1)

---

## DATA MODEL DELTAS

### Tables/Columns to Verify (Not Create)
1. ✅ `matches` table - EXISTS
2. ✅ `io_bookings` table - EXISTS
3. ✅ `io_bookings.promo_code` - EXISTS
4. ✅ `io_bookings.vanity_url` - EXISTS
5. ✅ `campaigns.stage` - EXISTS
6. ✅ `campaigns.stage_changed_at` - EXISTS

### Indexes to Verify/Create
1. `ux_metrics_daily_day_ep_source` - **VERIFY EXISTS** (may need to create)
   - Should be unique index on `metrics_daily(day, episode_id, source)` (may include tenant_id)

### Migration Pack Structure
Since most tables exist from previous migration (`20251113_064143`), new migration pack will:
1. Verify existing objects exist
2. Add missing indexes
3. Add any missing columns (if any)
4. Create rollback script

---

## GUARDRAILS

### Idempotent Migrations
- All migrations use `IF NOT EXISTS` / `DO $$ BEGIN ... END $$` patterns
- No DROP/RENAME operations
- Rollback script uses `IF EXISTS` guards

### Backups
- Migration scripts log to `/docs/run-logs/`
- Rollback script provided for each migration pack

### Feature Flags
- All new features behind flags (already implemented)
- Flags documented in `.env.example`

### Rollbacks
- Each migration pack includes `99_rollback.sql`
- Rollback uses `IF EXISTS` guards
- Safe to run multiple times

---

## ACCEPTANCE CRITERIA

### A) ETL Fallbacks
- [ ] Sample CSV files exist (`samples/metrics_daily.csv`, `samples/io_bookings.csv`)
- [ ] CSV uploader functional (already exists)
- [ ] Unique index `ux_metrics_daily_day_ep_source` exists or created
- [ ] Google Sheets Apps Script snippet added (optional)

### B) Deal Pipeline & IO
- [ ] Deal pipeline functional (already exists)
- [ ] IO workflow functional (already exists)
- [ ] `io.delivered` event emitted when IO completes

### C) Matchmaking Endpoint
- [ ] Matchmaking endpoint functional (already exists)
- [ ] Feature flag documented

### D) Dashboard Cards
- [ ] Dashboard APIs functional (already exist)
- [ ] Frontend components render (already exist)

### E) Events/Logs
- [ ] All required events emitted
- [ ] Event logger functional (already exists)

### F) Migration Scripts
- [ ] `scripts/db_migrate.sh` exists and executable
- [ ] `scripts/db_rollback.sh` exists and executable
- [ ] Migration pack created in `migrations/20251113T114706Z/`
- [ ] Rollback script tested

### G) Verification
- [ ] `scripts/verify_run.sql` exists
- [ ] Verification script checks all required objects

---

## NO-GO CHANGES (Prohibited)

1. ❌ Convert `metrics_daily` from view to table (destructive)
2. ❌ Rename existing feature flags (breaking change)
3. ❌ Move or refactor existing API endpoints (breaking change)
4. ❌ Change database schema of existing tables (destructive)
5. ❌ Remove or rename existing columns (destructive)

---

## IMPLEMENTATION ORDER

1. **Phase 3:** Create migration pack (verify existing, add missing indexes)
2. **Phase 4A:** Create sample CSV files
3. **Phase 4B:** Add `io.delivered` event emission
4. **Phase 4C:** Document matchmaking feature flag
5. **Phase 4D:** (No changes - dashboards exist)
6. **Phase 4E:** (Covered in 4B)
7. **Phase 4F:** Create migration scripts (`db_migrate.sh`, `db_rollback.sh`)
8. **Phase 4G:** Create verification script (`verify_run.sql`)

---

## GATE STATUS

✅ **PASS** - Plan is strictly additive and aligns with inventory.

**Next Steps:**
- Phase 3: Create migration pack with verification logic
- Phase 4: Implement minimal deltas identified above
