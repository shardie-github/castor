# Phase 3 — Safe DB Migration Pack Notes

**RUN-ID**: `20251113_064143`  
**Timestamp**: 2025-11-13T06:41:43Z  
**Phase**: 3 — Safe DB Migration Pack

---

## Migration Files Created

### 1. `/migrations/20251113_064143/01_detect_and_add.sql`
- **Purpose**: Create new tables and add columns
- **Tables Created**:
  - `etl_imports` - Track CSV/Google Sheets imports
  - `ad_units` - Ad unit definitions (pre/mid/post-roll)
  - `io_bookings` - Insertion orders with flight dates
  - `matches` - Advertiser-podcast matchmaking scores
- **Columns Added**:
  - `campaigns.stage` - Deal pipeline stage
  - `campaigns.stage_changed_at` - Timestamp of stage change
- **Indexes**: 15 new indexes
- **Idempotency**: All operations use `IF NOT EXISTS` or existence checks

### 2. `/migrations/20251113_064143/02_policies.sql`
- **Purpose**: Enable RLS and create tenant isolation policies
- **RLS Enabled**: 4 tables
- **Policies Created**: 4 tenant isolation policies
- **Idempotency**: Checks for existing policies before creating

### 3. `/migrations/20251113_064143/README.md`
- **Purpose**: Documentation, preconditions, run steps, rollback procedures
- **Includes**: Backup instructions, verification queries, rollback script

---

## Schema Diff Summary

### Additive Changes Only
- ✅ No tables dropped
- ✅ No columns dropped
- ✅ No indexes dropped
- ✅ No constraints removed

### New Objects
- **Tables**: 4 (`etl_imports`, `ad_units`, `io_bookings`, `matches`)
- **Columns**: 2 (`campaigns.stage`, `campaigns.stage_changed_at`)
- **Indexes**: 15
- **RLS Policies**: 4
- **Constraints**: 1 (`valid_stage` on campaigns)

---

## Dry-Run Parsing

### SQL Syntax Check
- ✅ All SQL statements are valid PostgreSQL syntax
- ✅ Transaction blocks (`BEGIN`/`COMMIT`) used
- ✅ Foreign key references verified against existing tables
- ✅ Check constraints use valid enum values
- ✅ Index names are unique

### Idempotency Verification
- ✅ `CREATE TABLE IF NOT EXISTS` - Safe to run multiple times
- ✅ `ADD COLUMN IF NOT EXISTS` - Safe to run multiple times
- ✅ Index creation checks existence via `pg_class` query
- ✅ Policy creation checks existence via `pg_policies` query
- ✅ Constraint creation checks existence via `pg_constraint` query

### RLS Pattern Consistency
- ✅ Mirrors existing RLS pattern from `migrations/003_multi_tenant_schema.sql`
- ✅ Uses `current_setting('app.current_tenant', TRUE)::UUID`
- ✅ All new tables have tenant_id column
- ✅ All policies follow naming convention: `tenant_isolation_<table_name>`

---

## Preconditions Verified

- ✅ `tenants` table exists (from migration 003)
- ✅ `campaigns` table exists (from migration 001)
- ✅ `podcasts` table exists (from migration 001)
- ✅ `episodes` table exists (from migration 001)
- ✅ `sponsors` table exists (from migration 001)
- ✅ UUID extension available (`gen_random_uuid()`)
- ✅ TimescaleDB extension available (not required for these tables)

---

## Rollback Safety

### Rollback Script Provided
- ✅ Complete rollback script in `README.md`
- ✅ Drops policies first (no dependencies)
- ✅ Drops tables in correct order (respects FK dependencies)
- ✅ Drops columns and constraints
- ✅ Drops indexes
- ✅ All operations use `IF EXISTS` for safety

### Backup Recommendations
- ✅ Documented backup procedure in README
- ✅ Rollback via backup option provided

---

## Acceptance Criteria

### Schema Diff Check
- ✅ Only intended additive objects exist
- ✅ No unintended changes
- ✅ All foreign keys reference existing tables
- ✅ All constraints are valid

### Dry-Run Status
- ✅ SQL parsing successful (no syntax errors)
- ✅ Idempotency verified
- ✅ RLS pattern consistent

**Status**: ✅ **READY TO PROCEED TO PHASE 4**

---

**Next Steps**: Phase 4 — Delta Implementation (modules only, no refactor)
