# Phase 1 — Recon & Inventory Report

**RUN-ID**: `20251113_064143`  
**Timestamp**: 2025-11-13T06:41:43Z  
**Phase**: 1 — Recon & Inventory (read-only)

---

## SYSTEM INVENTORY

### Repository Structure
- **Type**: Monorepo (Python backend + Next.js frontend)
- **Backend**: `/workspace/src/` (Python/FastAPI)
- **Frontend**: `/workspace/frontend/` (Next.js/TypeScript)
- **Migrations**: `/workspace/migrations/` (15 SQL files)
- **Scripts**: `/workspace/scripts/` (setup, init, health checks)
- **Documentation**: `/workspace/docs/`

### Backend Stack
- **Framework**: FastAPI 0.104.1
- **Entry Point**: `src/main.py`
- **Database**: PostgreSQL 15 + TimescaleDB extension
- **Cache**: Redis 7
- **ORM**: SQLAlchemy 2.0.23 + asyncpg 0.29.0
- **Validation**: Pydantic 2.5.0
- **Package Manager**: pip (requirements.txt)

### Frontend Stack
- **Framework**: Next.js 14.0.0
- **Language**: TypeScript 5.2.0
- **UI**: React 18.2.0, TailwindCSS 3.3.0
- **Charts**: Recharts 2.10.0
- **State**: Zustand 4.4.0
- **Package Manager**: npm/yarn (package.json)

### Infrastructure
- **Containerization**: Docker Compose
- **Orchestration**: Kubernetes (k8s/deployment.yaml)
- **Monitoring**: Prometheus + Grafana
- **IaC**: Terraform (terraform/)

### Observability
- **Metrics**: Prometheus client (`src/telemetry/metrics.py`)
- **Events**: Event logger (`src/telemetry/events.py`)
- **Health**: Health check service (`src/monitoring/health.py`)
- **Logging**: Python logging module

---

## DATA MODEL SNAPSHOT

### Core Tables

#### 1. `users`
- **Columns**: user_id (PK), email, password_hash, name, role, subscription_tier, persona_segment, tenant_id (FK), created_at, updated_at, last_login, is_active, metadata (JSONB)
- **Indexes**: email, subscription_tier, persona_segment, tenant_id, is_active (partial)
- **RLS**: Enabled (tenant isolation)

#### 2. `tenants`
- **Columns**: tenant_id (PK), name, slug (unique), domain, subscription_tier, status, billing_email, created_at, updated_at, metadata (JSONB)
- **Indexes**: slug, domain (partial), status
- **RLS**: N/A (system table)

#### 3. `podcasts`
- **Columns**: podcast_id (PK), user_id (FK), tenant_id (FK), title, description, author, image_url, feed_url, website_url, language, category, explicit, platform_configs (JSONB), ingestion_status, last_ingested_at, created_at, updated_at, metadata (JSONB)
- **Indexes**: user_id, feed_url, ingestion_status, created_at, tenant_id
- **RLS**: Enabled (tenant isolation)

#### 4. `episodes`
- **Columns**: episode_id (PK), podcast_id (FK), guid, title, description, audio_url, duration_seconds, publish_date, link, author, categories (TEXT[]), explicit, transcript_url, transcript_status, ad_slots (JSONB), created_at, updated_at, metadata (JSONB)
- **Indexes**: podcast_id, publish_date, guid, transcript_status (partial)
- **Unique**: (podcast_id, guid)
- **RLS**: N/A (via podcast tenant_id)

#### 5. `sponsors`
- **Columns**: sponsor_id (PK), user_id (FK), tenant_id (FK), name, company, email, contact_name, phone, website, logo_url, industry, created_at, updated_at, metadata (JSONB)
- **Indexes**: user_id, name, tenant_id
- **RLS**: Enabled (tenant isolation)

#### 6. `campaigns`
- **Columns**: campaign_id (PK), user_id (FK), podcast_id (FK), sponsor_id (FK), tenant_id (FK), name, status, start_date, end_date, campaign_value, episode_ids (UUID[]), attribution_config (JSONB), notes, created_at, updated_at, metadata (JSONB)
- **Indexes**: user_id, podcast_id, sponsor_id, status, date_range, episode_ids (GIN), tenant_id
- **Status Values**: draft, scheduled, active, paused, completed, cancelled
- **RLS**: Enabled (tenant isolation)

### Time-Series Tables (TimescaleDB Hypertables)

#### 7. `listener_events` (hypertable)
- **Columns**: event_id (PK), timestamp, podcast_id, episode_id, campaign_id, tenant_id (FK), event_type, platform, country_code, device_type, device_os, listen_duration_seconds, completion_rate, user_agent, ip_address, session_id, metadata (JSONB)
- **Indexes**: podcast_id+timestamp, episode_id+timestamp, campaign_id+timestamp (partial), platform+timestamp, event_type+timestamp, tenant_id
- **Retention**: 90 days
- **Continuous Aggregates**: hourly, daily
- **RLS**: Enabled (tenant isolation)

#### 8. `attribution_events` (hypertable)
- **Columns**: event_id (PK), timestamp, campaign_id (FK), podcast_id (FK), episode_id (FK), tenant_id (FK), attribution_method, attribution_data (JSONB), conversion_data (JSONB), listener_event_id, user_id, session_id, device_id, cross_device_match_id, demographic_lift (JSONB), metadata (JSONB)
- **Indexes**: campaign_id+timestamp, podcast_id+timestamp, method+timestamp, user_id (partial), cross_device_match_id (partial), tenant_id
- **Retention**: 2 years
- **RLS**: Enabled (tenant isolation)

#### 9. `listener_metrics` (hypertable)
- **Columns**: timestamp, podcast_id, episode_id, tenant_id (FK), metric_type, value, platform, country, device, metadata (JSONB)
- **Indexes**: podcast_id+timestamp, episode_id+timestamp, metric_type+timestamp, tenant_id
- **Retention**: 90 days
- **RLS**: Enabled (tenant isolation)

### Advanced Attribution Tables

#### 10. `attribution_models`
- **Columns**: model_id (PK), tenant_id (FK), campaign_id (FK), model_type, configuration (JSONB), is_active, created_at, updated_at
- **Model Types**: first_touch, last_touch, linear, time_decay, position_based, custom
- **RLS**: Enabled

#### 11. `attribution_paths`
- **Columns**: path_id (PK), tenant_id (FK), campaign_id (FK), user_id, session_id, device_id, conversion_id, touchpoints (JSONB), conversion_value, conversion_type, first_touch_at, last_touch_at, conversion_at, created_at, metadata (JSONB)
- **RLS**: Enabled

#### 12. `attribution_validations`
- **Columns**: validation_id (PK), tenant_id (FK), campaign_id (FK), model_id (FK), validation_type, ground_truth_value, predicted_value, accuracy_score, confidence_interval_lower, confidence_interval_upper, validation_status, validated_at, created_at, metadata (JSONB)
- **RLS**: Enabled

#### 13. `attribution_analytics`
- **Columns**: analytics_id (PK), tenant_id (FK), campaign_id (FK), model_id (FK), date, metric_type, metric_value, breakdown (JSONB), created_at
- **RLS**: Enabled

### Integration Tables

#### 14. `integrations`
- **Columns**: integration_id (PK), tenant_id (FK), integration_name, integration_type, status, configuration (JSONB), last_synced_at, last_error, error_count, created_at, updated_at, metadata (JSONB)
- **Types**: hosting, ecommerce, marketing, communication, automation
- **RLS**: Enabled

#### 15. `integration_tokens`
- **Columns**: token_id (PK), tenant_id (FK), integration_name, token_value, refresh_token, token_type, expires_at, scopes (TEXT[]), created_at, updated_at
- **RLS**: Enabled

#### 16. `integration_sync_logs`
- **Columns**: log_id (PK), tenant_id (FK), integration_name, sync_type, status, records_synced, records_failed, started_at, completed_at, error_message, metadata (JSONB)
- **RLS**: Enabled

### Other Tables
- `transcripts`, `reports`, `tenant_settings`, `tenant_quotas`, `roles`, `user_roles`, `permissions`, `role_permissions`, `resource_ownership`, `access_control_policies`, `access_logs`, `audit_logs`, `security_events`, `gdpr_requests`, `api_keys`, `cost_allocations`, `resource_usage`, `cost_alerts`, `experiments`, `experiment_assignments`, `experiment_events`, `churn_events`, `onboarding_steps`, `onboarding_progress`, `referrals`, `referral_commissions`, `marketplace_listings`, `marketplace_revenue`, `partners`, `partner_integrations`, `scheduled_tasks`, `predictions`, `recommendations`, `conversion_events`, `offline_conversions`, `risks`, `risk_mitigations`, `replication_status`, `webhooks`

### Missing Domain Objects (from requirements)
- ❌ **`io_bookings`** - Insertion orders/IO bookings table (NOT FOUND)
- ❌ **`metrics_daily`** - Daily aggregated metrics table (NOT FOUND; `listener_metrics` exists but is time-series)
- ❌ **`ad_units`** - Ad unit definitions table (NOT FOUND)
- ❌ **`advertisers`** - Advertiser table (NOT FOUND; `sponsors` exists but may not cover all advertiser use cases)
- ❌ **`deals`** - Deal pipeline table (NOT FOUND; `campaigns` exists but lacks pipeline stages)
- ❌ **`matches`** - Matchmaking/scoring table (NOT FOUND)

---

## INTEGRATIONS FOUND

### Hosting Platforms
- ✅ **Anchor** (`src/integrations/hosting/anchor.py`)
- ✅ **Buzzsprout** (`src/integrations/hosting/buzzsprout.py`)
- ✅ **Simplecast** (`src/integrations/hosting/simplecast.py`)
- ❌ **Libsyn** (NOT FOUND)
- ❌ **Podbean** (NOT FOUND)
- ❌ **Castos** (NOT FOUND)
- ❌ **Transistor** (NOT FOUND)

### E-commerce
- ✅ **Shopify** (`src/integrations/shopify.py`)
- ✅ **Wix** (`src/integrations/wix.py`)
- ❌ **WooCommerce** (NOT FOUND)
- ❌ **BigCommerce** (NOT FOUND)
- ❌ **Squarespace** (NOT FOUND)

### Marketing/Analytics
- ❌ **Google Analytics/GA4** (NOT FOUND)
- ❌ **UTM tracking** (NOT FOUND; attribution_events has UTM in JSONB but no dedicated handler)
- ❌ **Chartable** (NOT FOUND)
- ❌ **Podsights** (NOT FOUND)
- ❌ **HubSpot** (NOT FOUND)
- ❌ **Salesforce** (NOT FOUND)

### Platform APIs
- ❌ **Spotify for Podcasters API** (NOT FOUND)
- ❌ **Apple Podcasts Connect API** (NOT FOUND)
- ❌ **YouTube** (NOT FOUND)
- ❌ **Google Podcasts Manager** (NOT FOUND)

### Link Shorteners
- ❌ **Vanity URL generation** (NOT FOUND)
- ❌ **Promo code tracking** (NOT FOUND; attribution_events has promo_code in JSONB but no dedicated service)

### Automation
- ✅ **Zapier** (`src/integrations/zapier.py`)
- ❌ **Google Sheets** (NOT FOUND)
- ❌ **Make/n8n** (NOT FOUND)

### CRM/Payments
- ❌ **CRM integration** (NOT FOUND; sponsors table exists but no CRM sync)
- ✅ **Stripe** (via `src/payments/stripe.py`)

### PDF/Export
- ✅ **Report generation** (`src/reporting/report_generator.py`) - supports PDF/CSV/Excel/JSON

---

## API ENDPOINTS

### Existing Endpoints
- `/api/v1/tenants/*` - Tenant management
- `/api/v1/attribution/*` - Attribution calculation
- `/api/v1/ai/*` - AI features (transcript analysis)
- `/api/v1/cost/*` - Cost tracking
- `/api/v1/security/*` - Security (API keys, MFA)
- `/api/v1/backup/*` - Backup management
- `/api/v1/optimization/*` - Optimization (experiments, churn, onboarding)
- `/api/v1/partners/*` - Partnerships (referrals, marketplace)
- `/api/v1/business/*` - Business dashboard
- `/risks/*` - Risk management

### Missing Endpoints (from requirements)
- ❌ **`POST /api/match/recalculate`** - Matchmaking recalculation (NOT FOUND)
- ❌ **`POST /api/etl/upload`** - CSV upload endpoint (NOT FOUND)
- ❌ **`GET /api/etl/status`** - ETL status endpoint (NOT FOUND)
- ❌ **`POST /api/deals`** - Deal creation (NOT FOUND; campaigns exist but no deal pipeline)
- ❌ **`POST /api/io`** - IO booking creation (NOT FOUND)

---

## OBSERVABILITY & OPS

### Logging
- ✅ **Event Logger**: `src/telemetry/events.py` - User actions, feature usage, friction signals
- ✅ **Python Logging**: Standard logging module
- ✅ **Audit Logs**: `audit_logs` table with RLS

### Metrics
- ✅ **Prometheus**: Metrics collector (`src/telemetry/metrics.py`)
- ✅ **Metrics Endpoint**: `/metrics`
- ✅ **Health Checks**: `/health` endpoint

### Jobs/Cron
- ✅ **Background Tasks**: `src/agents/background_tasks.py` - Feed updates, analytics aggregation, anomaly detection
- ✅ **Scheduled Tasks**: `scheduled_tasks` table
- ❌ **Cron Configuration**: No explicit cron.yaml or scheduled job definitions found

### CI/CD
- ❌ **CI Pipeline**: No `.github/workflows/` or `.gitlab-ci.yml` found

### Tests
- ✅ **Test Framework**: pytest (pytest, pytest-asyncio, pytest-cov)
- ✅ **Test Directory**: `/tests/` (6 Python test files)
- ❌ **E2E Tests**: Not found

---

## PAIN POINTS & GAPS

### Critical Gaps

1. **Missing Deal Pipeline**
   - `campaigns` table exists but lacks pipeline stages (lead → qualified → proposal → negotiation → won/lost)
   - No deal management UI/API

2. **Missing IO Bookings**
   - No `io_bookings` table
   - No IO creation/management
   - No flight dates, booked impressions, CPM tracking
   - No promo code/vanity URL generation service

3. **Missing Metrics Daily Aggregation**
   - `listener_metrics` exists as time-series but no `metrics_daily` aggregated table
   - No daily rollup for downloads, listeners, completion_rate, CTR, conversions, revenue

4. **Missing ETL Fallback**
   - No CSV upload functionality
   - No Google Sheets import
   - No manual data ingestion endpoint

5. **Missing Matchmaking**
   - No `/api/match/recalculate` endpoint
   - No `matches` table for advertiser-podcast scoring
   - No matchmaking algorithm

6. **Missing Dashboard Cards**
   - Frontend has chart components but no specific dashboard cards for:
     - Creator: pacing vs flight, sponsor revenue, makegoods pending
     - Advertiser/Agency: audience fit summary, projected CPM, inventory calendar
     - Ops: pipeline forecast, win/loss, ETL health

### Fragile Parts

1. **Tenant Isolation**
   - TODO comment in `src/tenants/tenant_isolation.py` (line 43): "TODO: Lookup tenant by slug"
   - RLS policies rely on `current_setting('app.current_tenant')` which must be set correctly

2. **Attribution Matching**
   - Attribution events stored in JSONB; no structured promo_code/vanity_url columns
   - Cross-device matching exists but may need enhancement

3. **Integration Framework**
   - Base class exists but many integrations are stubs
   - No error recovery/retry logic visible in base class

### Missing Guards

1. **Data Validation**
   - No Zod-equivalent validation for CSV uploads (Pydantic exists but not used for ETL)
   - No unique constraint validation for metrics_daily upserts

2. **Feature Flags**
   - No feature flag system found
   - New features should be behind flags (default OFF)

3. **Rollback Procedures**
   - Migrations use `IF NOT EXISTS` but no documented rollback scripts

---

## DELTA CANDIDATES (Smallest Additive Features)

### Priority 1: ETL Fallback (CSV Upload)
- **Effort**: Medium
- **Impact**: High
- **Dependencies**: None
- **Changes**:
  - Add `POST /api/v1/etl/upload` endpoint
  - Add CSV validation (Pydantic schema)
  - Add `metrics_daily` table (if not exists) or upsert into `listener_metrics`
  - Add `etl_imports` table for tracking imports
  - Add UI component for CSV drag-drop upload

### Priority 2: Deal Pipeline Extension
- **Effort**: Medium
- **Impact**: High
- **Dependencies**: campaigns table
- **Changes**:
  - Add `stage` column to `campaigns` table (if not exists)
  - Add pipeline stages: lead, qualified, proposal, negotiation, won, lost
  - Add `POST /api/v1/deals` endpoint (or extend campaigns)
  - Add deal pipeline UI component

### Priority 3: IO Bookings
- **Effort**: High
- **Impact**: High
- **Dependencies**: campaigns, episodes, ad_units (may need to create)
- **Changes**:
  - Add `io_bookings` table
  - Add `ad_units` table (if needed)
  - Add `POST /api/v1/io` endpoint
  - Add IO wizard/modal UI
  - Add promo_code/vanity_url generation utilities

### Priority 4: Matchmaking Endpoint
- **Effort**: Medium
- **Impact**: Medium
- **Dependencies**: advertisers (or sponsors), podcasts
- **Changes**:
  - Add `matches` table
  - Add `POST /api/match/recalculate` endpoint
  - Add matchmaking algorithm (geo/demo/topic overlaps, historical lift)
  - Feature flag: `ENABLE_MATCHMAKING` (default OFF)

### Priority 5: Dashboard Cards
- **Effort**: Low-Medium
- **Impact**: Medium
- **Dependencies**: Existing charts, new data sources
- **Changes**:
  - Add incremental dashboard cards (reuse existing chart components)
  - Add API endpoints for card data
  - No changes to existing cards

### Priority 6: Events/Logs Enhancement
- **Effort**: Low
- **Impact**: Low-Medium
- **Dependencies**: Existing event logger
- **Changes**:
  - Emit new event types: `deal.stage_changed`, `io.scheduled`, `io.delivered`, `etl.import_completed`, `etl.error`, `match.recalculated`
  - Extend existing `EventLogger` class

---

## ACCEPTANCE TO PROCEED

✅ **Inventory doc exists and is internally consistent**

- All tables documented from migrations
- All integrations catalogued
- Gaps identified and prioritized
- Delta candidates scoped with effort/impact

**Status**: ✅ **READY TO PROCEED TO PHASE 2**

---

**Next Steps**: Phase 2 — Extension Plan (additive, minimal-change)
