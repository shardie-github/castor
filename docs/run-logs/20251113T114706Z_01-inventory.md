# Phase 1 — Recon & Inventory
**RUN-ID:** 20251113T114706Z  
**Timestamp:** 2025-11-13T11:47:06Z UTC

## SYSTEM INVENTORY

### Repository Type
- **Type:** Monorepo
- **Backend:** Python 3.11+ (FastAPI 0.104.1)
- **Frontend:** Next.js 14 (TypeScript/React)
- **Package Managers:**
  - Backend: `pip` (requirements.txt)
  - Frontend: `npm` (package.json)

### Database Stack
- **Primary DB:** PostgreSQL 15 (TimescaleDB extension)
- **Cache:** Redis 7
- **Observability:** Prometheus + Grafana
- **ORM:** SQLAlchemy 2.0, asyncpg

### Entry Points
- **Backend:** `src/main.py` (FastAPI app)
- **Frontend:** `frontend/app/` (Next.js app router)
- **Migrations:** `migrations/` (15 existing numbered migrations + `20251113_064143/`)

### Scripts
- `scripts/init_db.py` - Database initialization
- `scripts/check_health.py` - Health checks
- `scripts/verify_setup.py` - Setup verification
- `scripts/setup.sh` - Setup script
- `scripts/start_infrastructure.sh` - Infrastructure startup
- **MISSING:** `scripts/db_migrate.sh`, `scripts/db_rollback.sh`

---

## DATA MODEL SNAPSHOT

### Core Tables (from migrations/001_initial_schema.sql)
- `users` - User accounts with roles/tiers
- `podcasts` - Podcast metadata
- `episodes` - Episode metadata
- `sponsors` - Sponsor/advertiser records
- `campaigns` - Campaign records (extended with `stage`, `stage_changed_at` in migration `20251113_064143`)
- `listener_events` - Time-series events (hypertable)
- `attribution_events` - Attribution tracking (hypertable)
- `listener_metrics` - Aggregated metrics (hypertable)
- `reports` - Generated reports
- `transcripts` - Episode transcripts

### Multi-Tenant (from migrations/003_multi_tenant_schema.sql)
- `tenants` - Tenant records
- `tenant_settings` - Tenant configuration
- `tenant_quotas` - Usage quotas
- **RLS Enabled:** Yes, on all tenant-scoped tables

### Delta Tables (from migrations/20251113_064143/)
- `etl_imports` - ETL import tracking
- `ad_units` - Ad unit definitions
- `io_bookings` - Insertion order bookings
  - Columns: `io_id`, `tenant_id`, `campaign_id`, `ad_unit_id`, `episode_id`, `flight_start`, `flight_end`, `booked_impressions`, `booked_cpm_cents`, `promo_code`, `vanity_url`, `status`, `created_at`, `updated_at`, `metadata`
- `matches` - Matchmaking scores
  - Columns: `match_id`, `tenant_id`, `advertiser_id`, `podcast_id`, `score`, `rationale`, `signals`, `created_at`, `updated_at`
  - Unique constraint: `(tenant_id, advertiser_id, podcast_id)`

### Views
- `metrics_daily` - MATERIALIZED VIEW (from `listener_metrics`)
  - Columns: `day`, `episode_id`, `podcast_id`, `tenant_id`, `source`, `downloads`, `listeners`, `completion_rate`, `ctr`, `conversions`, `revenue_cents`, `last_updated`
  - Unique index: `idx_metrics_daily_unique` on `(day, episode_id, source, tenant_id)`
  - **NOTE:** View is refreshed via `refresh_metrics_daily()` function

### Indexes to Verify
- `ux_metrics_daily_day_ep_source` - **NEEDS CHECK** (may not exist, should be on `metrics_daily`)
- `idx_metrics_daily_unique` - Exists (on `metrics_daily`)

---

## INTEGRATIONS FOUND

### Platform APIs
- **RSS/Feed:** `src/ingestion/rss_ingest.py`
- **Hosting Platforms:** `src/integrations/hosting/` (Anchor, Buzzsprout, Simplecast)
- **Google Workspace:** `src/integrations/google_workspace.py`
- **Shopify:** `src/integrations/shopify.py`
- **Zapier:** `src/integrations/zapier.py`
- **Wix:** `src/integrations/wix.py`

### Analytics/Attribution
- **Attribution Engine:** `src/attribution/attribution_engine.py`
- **Cross-Platform:** `src/attribution/cross_platform.py`
- **Models:** First-touch, last-touch, linear, position-based, time-decay

### Payments
- **Stripe:** `src/payments/stripe.py`

### ETL
- **CSV Importer:** `src/etl/csv_importer.py` ✅ EXISTS
  - Imports to `listener_metrics` table (not `metrics_daily` view)
- **Google Sheets:** `src/etl/google_sheets.py` ✅ EXISTS

---

## DOMAIN OBJECTS PRESENT

### ✅ EXISTS
- **Orgs/Users:** `users`, `tenants` tables
- **Podcasts/Episodes:** `podcasts`, `episodes` tables
- **Ad Units:** `ad_units` table
- **Advertisers/Sponsors:** `sponsors` table (used as `advertiser_id` in matches)
- **Deals:** `campaigns` table (with `stage`, `stage_changed_at` columns)
- **IO Bookings:** `io_bookings` table (with `promo_code`, `vanity_url` columns)
- **Metrics Daily:** `metrics_daily` MATERIALIZED VIEW
- **Events:** `listener_events`, `attribution_events` tables
- **Matches:** `matches` table

---

## API ENDPOINTS FOUND

### ETL
- `POST /api/v1/etl/upload` - CSV upload ✅ EXISTS
- `GET /api/v1/etl/status/{import_id}` - Import status ✅ EXISTS
- `GET /api/v1/etl/history` - Import history ✅ EXISTS
- **Feature Flag:** `ENABLE_ETL_CSV_UPLOAD`

### Matchmaking
- `POST /api/match/recalculate` - Recalculate matches ✅ EXISTS
- **Feature Flag:** `ENABLE_MATCHMAKING` (not `MATCHMAKING_ENABLED`)

### IO Bookings
- `POST /api/v1/io` - Create IO booking ✅ EXISTS
- `GET /api/v1/io/{io_id}` - Get IO booking ✅ EXISTS
- `GET /api/v1/io/{io_id}/export/pdf` - Export IO PDF ✅ EXISTS
- **Feature Flag:** `ENABLE_IO_BOOKINGS`

### Deals Pipeline
- `PATCH /api/v1/deals/{campaign_id}/stage` - Update deal stage ✅ EXISTS
- `GET /api/v1/deals/{campaign_id}` - Get deal ✅ EXISTS
- **Feature Flag:** `ENABLE_DEAL_PIPELINE`

### Dashboard
- `GET /api/v1/dashboard/creator` - Creator dashboard ✅ EXISTS
- `GET /api/v1/dashboard/advertiser` - Advertiser dashboard ✅ EXISTS
- `GET /api/v1/dashboard/ops` - Ops dashboard ✅ EXISTS
- **Feature Flag:** `ENABLE_NEW_DASHBOARD_CARDS`

---

## FRONTEND COMPONENTS

### ✅ EXISTS
- `frontend/components/etl/CSVUploader.tsx` - CSV upload UI
- `frontend/components/dashboard/CreatorDashboard.tsx`
- `frontend/components/dashboard/AdvertiserDashboard.tsx`
- `frontend/components/dashboard/OpsDashboard.tsx`
- `frontend/components/charts/` - Chart components (TimeSeriesChart, FunnelChart, HeatmapChart)

---

## OBSERVABILITY & OPS

### Logging
- **Event Logger:** `src/telemetry/events.py` ✅ EXISTS
- **Metrics Collector:** `src/telemetry/metrics.py` ✅ EXISTS
- **Health Checks:** `src/monitoring/health.py` ✅ EXISTS

### Jobs/Cron
- **Background Tasks:** `src/agents/background_tasks.py` ✅ EXISTS
- **Automation Jobs:** `src/agents/automation_jobs.py` ✅ EXISTS
- **Scheduler:** `scripts/schedule_automation_jobs.py` ✅ EXISTS

### Tests
- **Test Suite:** `tests/` directory (6 Python test files)

---

## GAPS & RISKS

### Critical Gaps
1. **CSV Import Target:** CSV importer writes to `listener_metrics`, not `metrics_daily` (view)
   - **Risk:** Data won't appear in `metrics_daily` until view refresh
   - **Solution:** Need upsert logic for `metrics_daily` or direct table insert

2. **Unique Index:** `ux_metrics_daily_day_ep_source` may not exist
   - **Risk:** Duplicate rows in `metrics_daily`
   - **Solution:** Verify and create if missing

3. **Migration Scripts:** `scripts/db_migrate.sh` and `scripts/db_rollback.sh` missing
   - **Risk:** No standardized migration execution
   - **Solution:** Create scripts per spec

4. **Sample CSV Files:** `samples/metrics_daily.csv` and `samples/io_bookings.csv` missing
   - **Solution:** Create sample files

5. **Verification Script:** `scripts/verify_run.sql` missing
   - **Solution:** Create verification SQL

6. **Google Sheets Fallback:** Exists but may need Apps Script snippet
   - **Solution:** Add Apps Script if appropriate

### Feature Flag Inconsistencies
- Matchmaking uses `ENABLE_MATCHMAKING` (not `MATCHMAKING_ENABLED` as spec)
- **Solution:** Align with spec or document existing flag

### Event Emission
- Events logged via `EventLogger.log_event()`
- **Verify:** All required events are emitted:
  - ✅ `deal.stage_changed` (in deals API)
  - ✅ `io.scheduled` (in IO API)
  - ✅ `match.recalculated` (in match API)
  - ✅ `etl.import_completed` (in ETL API)
  - ✅ `etl.error` (in ETL API)
  - **MISSING:** `io.delivered` (may need to add)

---

## DELTA CANDIDATES (Smallest Additive Features)

### 1. CSV Import Enhancement
- **Current:** Imports to `listener_metrics`
- **Needed:** Option to upsert directly to `metrics_daily` table (if converted from view) OR ensure view refresh
- **Change:** Minimal - add upsert path or refresh trigger

### 2. Unique Index Verification
- **Action:** Verify `ux_metrics_daily_day_ep_source` exists
- **If Missing:** Create index on `metrics_daily(day, episode_id, source)` (may need tenant_id too)

### 3. Migration Scripts
- **Action:** Create `scripts/db_migrate.sh` and `scripts/db_rollback.sh`
- **Change:** New files only

### 4. Sample Files
- **Action:** Create `samples/metrics_daily.csv` and `samples/io_bookings.csv`
- **Change:** New files only

### 5. Verification Script
- **Action:** Create `scripts/verify_run.sql`
- **Change:** New file only

### 6. Google Sheets Apps Script (Optional)
- **Action:** Add Apps Script snippet in `docs/sheets/push_metrics_daily.gs`
- **Change:** New file only

### 7. Environment Variable
- **Action:** Add `MATCHMAKING_ENABLED=false` to `.env.example` (or document existing `ENABLE_MATCHMAKING`)

### 8. IO Delivered Event
- **Action:** Add `io.delivered` event emission when IO status changes to 'completed'
- **Change:** Small addition to IO API

---

## PAIN POINTS

### Fragile Parts
1. **Materialized View Refresh:** `metrics_daily` requires manual refresh; no automatic trigger
2. **CSV Import Path:** Two-step process (import to `listener_metrics`, then refresh view)
3. **Feature Flags:** Multiple flags scattered; no centralized config

### TODOs Found
- None explicitly marked, but implicit gaps identified above

### Missing Guards
- No validation that `metrics_daily` view is refreshed after CSV import
- No check that unique constraint exists before CSV upsert

---

## GATE STATUS

✅ **PASS** - Inventory complete and internally consistent. Ready for Phase 2.

**Next Steps:**
- Phase 2: Create delta plan addressing gaps identified above
- Focus on additive-only changes
- Ensure idempotent migrations
- Verify feature flags align with spec
