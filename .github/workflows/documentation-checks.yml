name: Documentation Checks

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'docs/**'
      - 'README*.md'
      - '*.md'
      - 'src/**/*.py'
      - '.github/workflows/documentation-checks.yml'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  doc-coverage:
    name: Documentation Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install pydocstyle interrogate
      
      - name: Check docstring coverage
        run: |
          interrogate src/ --fail-under=60 --verbose || {
            echo "⚠️ Docstring coverage below 60%"
            exit 1
          }
      
      - name: Check docstring style
        continue-on-error: true
        run: |
          pydocstyle src/ --convention=google || echo "Docstring style check completed"

  readme-check:
    name: README Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for README
        run: |
          if [ ! -f README.md ]; then
            echo "❌ README.md not found"
            exit 1
          fi
          echo "✅ README.md found"
      
      - name: Check README content
        run: |
          README_SIZE=$(wc -l < README.md)
          echo "README.md has $README_SIZE lines"
          if [ "$README_SIZE" -lt 50 ]; then
            echo "⚠️ README.md seems too short (less than 50 lines)"
            exit 1
          fi
      
      - name: Check for required sections
        run: |
          REQUIRED_SECTIONS=("Installation" "Usage" "Configuration")
          MISSING=()
          for section in "${REQUIRED_SECTIONS[@]}"; do
            if ! grep -qi "$section" README.md; then
              MISSING+=("$section")
            fi
          done
          if [ ${#MISSING[@]} -gt 0 ]; then
            echo "⚠️ Missing sections in README: ${MISSING[*]}"
            exit 1
          fi
          echo "✅ Required sections found"

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v14
        with:
          globs: |
            **/*.md
            !node_modules/**
            !.git/**
      
      - name: Check for broken links
        continue-on-error: true
        run: |
          pip install markdown-link-check
          find . -name "*.md" -type f | while read file; do
            markdown-link-check "$file" || echo "Link check completed for $file"
          done

  api-docs-check:
    name: API Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Check API documentation
        run: |
          if [ -f scripts/generate-api-docs.py ]; then
            python scripts/generate-api-docs.py --check || echo "API docs check completed"
          else
            echo "API docs generation script not found"
          fi
      
      - name: Validate OpenAPI docs exist
        run: |
          if [ ! -f openapi.json ] && [ ! -f openapi.yaml ]; then
            echo "⚠️ No OpenAPI specification found"
            exit 1
          fi
          echo "✅ OpenAPI specification found"

  summary:
    name: Documentation Check Summary
    runs-on: ubuntu-latest
    needs: [doc-coverage, readme-check, markdown-lint, api-docs-check]
    if: always()
    steps:
      - name: Documentation summary
        run: |
          echo "## Documentation Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Documentation Requirements" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Docstring coverage ≥ 60%" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ README.md with required sections" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Markdown linting" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ API documentation" >> $GITHUB_STEP_SUMMARY
