name: PR Requirements Check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  pr-requirements:
    name: PR Requirements Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check PR title
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          
          # Check minimum length
          if [ ${#TITLE} -lt 10 ]; then
            echo "❌ PR title is too short (minimum 10 characters)"
            exit 1
          fi
          
          # Check for conventional commit format (optional but recommended)
          if [[ ! "$TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\(.+\))?: ]]; then
            echo "⚠️ PR title doesn't follow conventional commit format"
            echo "Recommended format: type(scope): description"
            echo "Example: feat(api): Add user authentication endpoint"
          else
            echo "✅ PR title follows convention"
          fi
      
      - name: Check PR description
        run: |
          BODY="${{ github.event.pull_request.body }}"
          
          if [ -z "$BODY" ] || [ ${#BODY} -lt 50 ]; then
            echo "❌ PR description is too short (minimum 50 characters)"
            echo "Please provide a detailed description of your changes"
            exit 1
          fi
          
          echo "✅ PR description is sufficient"
      
      - name: Check for linked issues
        run: |
          BODY="${{ github.event.pull_request.body }}"
          
          # Check if PR references an issue
          if echo "$BODY" | grep -qiE "(closes|fixes|resolves|related to) #[0-9]+"; then
            echo "✅ PR references an issue"
          else
            echo "⚠️ PR doesn't reference any issues"
            echo "Consider linking related issues using: closes #123, fixes #456, etc."
          fi
      
      - name: Check file changes
        run: |
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          
          # Check for large files
          LARGE_FILES=$(git diff --numstat ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | \
            awk '{if ($1+$2 > 10000) print $3}')
          
          if [ -n "$LARGE_FILES" ]; then
            echo "⚠️ Large files detected:"
            echo "$LARGE_FILES"
            echo "Consider splitting large changes into smaller commits"
          fi
          
          # Check for deleted files without explanation
          DELETED_FILES=$(git diff --name-only --diff-filter=D ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          if [ -n "$DELETED_FILES" ] && ! echo "$BODY" | grep -qi "delete\|remove\|deprecate"; then
            echo "⚠️ Files deleted without explanation in PR description"
            echo "Deleted files: $DELETED_FILES"
          fi
      
      - name: Check for test files
        run: |
          CHANGED_SOURCE=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | \
            grep -E "^(src|frontend/src)" | grep -v "__pycache__" | grep -v ".pyc")
          
          CHANGED_TESTS=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | \
            grep -E "^tests/")
          
          if [ -n "$CHANGED_SOURCE" ] && [ -z "$CHANGED_TESTS" ]; then
            echo "⚠️ Source code changed but no test files modified"
            echo "Consider adding tests for your changes"
          else
            echo "✅ Tests included with source changes"
          fi
      
      - name: Check for breaking changes
        run: |
          BODY="${{ github.event.pull_request.body }}"
          TITLE="${{ github.event.pull_request.title }}"
          
          # Check if breaking changes are mentioned
          if echo "$BODY $TITLE" | grep -qiE "(breaking|BREAKING|deprecat|remove|delete)"; then
            if ! echo "$BODY" | grep -qiE "### Breaking Changes|## Breaking Changes"; then
              echo "⚠️ Breaking changes detected but not documented in PR description"
              echo "Please add a 'Breaking Changes' section to your PR description"
            else
              echo "✅ Breaking changes are documented"
            fi
          fi
      
      - name: Check CI status
        uses: actions/github-script@v6
        with:
          script: |
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha,
            });
            
            const requiredChecks = ['CI', 'Code Quality Gates', 'Security Scan'];
            const passedChecks = checks.check_runs
              .filter(check => check.status === 'completed' && check.conclusion === 'success')
              .map(check => check.name);
            
            console.log('Required checks:', requiredChecks);
            console.log('Passed checks:', passedChecks);
            
            const missingChecks = requiredChecks.filter(check => !passedChecks.includes(check));
            if (missingChecks.length > 0) {
              console.log('⚠️ Some required checks are not passing:', missingChecks);
            } else {
              console.log('✅ All required checks are passing');
            }

  summary:
    name: PR Requirements Summary
    runs-on: ubuntu-latest
    needs: [pr-requirements]
    if: always()
    steps:
      - name: PR requirements summary
        run: |
          echo "## PR Requirements Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### PR Requirements" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ PR title format" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ PR description length" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Issue references" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Test coverage" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Breaking changes documentation" >> $GITHUB_STEP_SUMMARY
