name: Docker Image Security Scan

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'Dockerfile*'
      - '.dockerignore'
      - '.github/workflows/docker-scan.yml'
  push:
    branches: [main, develop]
    paths:
      - 'Dockerfile*'
  workflow_dispatch:

jobs:
  dockerfile-lint:
    name: Dockerfile Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning
          ignore: DL3008,DL3009
      
      - name: Check Dockerfile.prod
        if: hashFiles('Dockerfile.prod') != ''
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile.prod
          failure-threshold: warning
          ignore: DL3008,DL3009

  docker-build-scan:
    name: Docker Build & Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.prod
          push: false
          tags: podcast-analytics-api:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'podcast-analytics-api:test'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Run Trivy scan (table output)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'podcast-analytics-api:test'
          format: 'table'
          severity: 'CRITICAL,HIGH'
      
      - name: Check for critical vulnerabilities
        run: |
          if [ -f trivy-results.sarif ]; then
            echo "Vulnerability scan completed. Check SARIF results."
          else
            echo "No vulnerabilities found or scan failed"
          fi

  docker-image-size:
    name: Docker Image Size Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker image
        run: |
          docker build -f Dockerfile.prod -t podcast-analytics-api:test . || \
          docker build -f Dockerfile -t podcast-analytics-api:test .
      
      - name: Check image size
        run: |
          SIZE=$(docker images podcast-analytics-api:test --format "{{.Size}}" | sed 's/[^0-9.]//g')
          echo "Image size: ${SIZE}"
          
          # Convert to MB if needed and check threshold (500MB)
          if [ -n "$SIZE" ]; then
            echo "Docker image size: ${SIZE}"
            if [ "$(echo "$SIZE > 500" | bc -l)" -eq 1 ]; then
              echo "⚠️ Docker image size exceeds 500MB"
              exit 1
            fi
          fi
      
      - name: Analyze image layers
        run: |
          docker history podcast-analytics-api:test --format "{{.Size}}\t{{.CreatedBy}}" | head -20

  summary:
    name: Docker Scan Summary
    runs-on: ubuntu-latest
    needs: [dockerfile-lint, docker-build-scan, docker-image-size]
    if: always()
    steps:
      - name: Docker scan summary
        run: |
          echo "## Docker Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Checks" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Dockerfile linting" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Container vulnerability scanning" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Image size optimization" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check GitHub Security tab for detailed vulnerability reports." >> $GITHUB_STEP_SUMMARY
