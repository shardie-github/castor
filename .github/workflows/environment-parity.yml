name: Environment Parity Check

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '.env*'
      - 'src/config/**'
      - '.github/workflows/environment-parity.yml'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  env-parity-check:
    name: Environment Parity Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Check environment files
        run: |
          if [ -f scripts/env-parity-checker.ts ]; then
            npm install -g typescript ts-node
            ts-node scripts/env-parity-checker.ts || echo "Environment parity check completed"
          elif [ -f scripts/env-doctor.py ]; then
            pip install pyyaml
            python scripts/env-doctor.py || echo "Environment check completed"
          else
            echo "Environment checker script not found, running basic check"
            
            # Basic check: ensure .env.example exists
            if [ ! -f .env.example ]; then
              echo "⚠️ .env.example not found"
              exit 1
            fi
            
            # Check that required vars are documented
            REQUIRED_VARS=("DATABASE_URL" "JWT_SECRET" "ENCRYPTION_KEY")
            for var in "${REQUIRED_VARS[@]}"; do
              if ! grep -q "$var" .env.example; then
                echo "⚠️ Required variable $var not documented in .env.example"
                exit 1
              fi
            done
            
            echo "✅ Basic environment check passed"
          fi
      
      - name: Validate environment variable consistency
        run: |
          # Check that all environments have same required variables
          if [ -f .env.example ] && [ -f .env.development ] && [ -f .env.production ]; then
            EXAMPLE_VARS=$(grep -v '^#' .env.example | grep -v '^$' | cut -d'=' -f1 | sort)
            DEV_VARS=$(grep -v '^#' .env.development | grep -v '^$' | cut -d'=' -f1 | sort)
            PROD_VARS=$(grep -v '^#' .env.production | grep -v '^$' | cut -d'=' -f1 | sort)
            
            if [ "$EXAMPLE_VARS" != "$DEV_VARS" ] || [ "$EXAMPLE_VARS" != "$PROD_VARS" ]; then
              echo "⚠️ Environment variables differ between environments"
              echo "Example vars: $(echo "$EXAMPLE_VARS" | wc -l)"
              echo "Dev vars: $(echo "$DEV_VARS" | wc -l)"
              echo "Prod vars: $(echo "$PROD_VARS" | wc -l)"
            else
              echo "✅ Environment variables are consistent"
            fi
          fi
      
      - name: Check for hardcoded secrets
        run: |
          # Check for common hardcoded secrets
          if grep -r "password.*=.*['\"][^'\"]\{8,\}['\"]" src/ --include="*.py" | grep -v "#" | grep -v "test"; then
            echo "⚠️ Potential hardcoded passwords detected"
            exit 1
          fi
          
          if grep -r "api_key.*=.*['\"][^'\"]\{10,\}['\"]" src/ --include="*.py" | grep -v "#" | grep -v "test"; then
            echo "⚠️ Potential hardcoded API keys detected"
            exit 1
          fi
          
          echo "✅ No hardcoded secrets detected"

  config-validation:
    name: Config Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Validate configuration files
        run: |
          if [ -f src/config/config.py ]; then
            python -c "
            import sys
            sys.path.insert(0, 'src')
            try:
                from config import load_config
                print('✅ Configuration module loads successfully')
            except Exception as e:
                print(f'❌ Configuration error: {e}')
                sys.exit(1)
            "
          fi
      
      - name: Check for missing environment variables
        run: |
          if [ -f scripts/validate-env.py ]; then
            python scripts/validate-env.py || echo "Environment validation completed"
          fi

  summary:
    name: Environment Parity Summary
    runs-on: ubuntu-latest
    needs: [env-parity-check, config-validation]
    if: always()
    steps:
      - name: Environment parity summary
        run: |
          echo "## Environment Parity Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Validation Checks" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Environment file consistency" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Required variables documented" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ No hardcoded secrets" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Configuration validation" >> $GITHUB_STEP_SUMMARY
